L.ui.view.extend({port_addNewEntery:function(b){if(this.className.indexOf("unable-opcity")!=-1){return}data=b.data;if(data.selfMap.sections[1].uci_type=="portSectionN"){data.selfMap.sections.splice(1,1)}data.selfMap=data.self.addCreatPort(data);data.selfMap.redraw();$("#port_addNewEntery").addClass("unable-opcity");$(".portSection1").addClass("unable-opcity");$(".port-add-icon").css("background",'url("/newifi/icons/portdmz-add.png") no-repeat 0 0')},editFun:function(h){var l=h.selfMap;var k=h.portOutside.split("-")[1]?h.portOutside.split("-")[1]:"";var i=h.portInside.split("-")[1]?h.portInside.split("-")[1]:"";var g={};g.portName=h.portName;g.portProtocol=h.portProtocol;g.portIp=h.portIp;g.portIpBefore=h.portIpBefore;g.portOutside0=h.portOutside.split("-")[0];g.portOutside1=k;g.portInside0=h.portInside.split("-")[0];g.portInside1=i;g.portState=h.portState;g.saveBtnStyle=h.saveBtnStyle;g.saveBtnText=h.saveBtnText;g.cancelBtnStyle=h.cancelBtnStyle;g.cancelBtnText=h.cancelBtnText;g.portStateText0=h.portStateText0;g.portStateText1=h.portStateText1;g.delBtnStyle=h.delBtnStyle;g.delBtnText=h.delBtnText;g.editBtnStyle=h.editBtnStyle;g.editBtnText=h.editBtnText;g.selfMap=l;g.self=h.self;g.ID=h.ID;l=g.self.addCreatPort(g);var j=l.sections.length;l.sections.splice(h.indexP,1,l.sections[j-1]);l.sections.splice(j-1,1);l.redraw();$("#port_addNewEntery").addClass("unable-opcity");$(".portSection1").addClass("unable-opcity");$(".port-add-icon").css("background",'url("/newifi/icons/portdmz-add.png") no-repeat 0 0')},delFun:function(c){var d=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"both",bodyText:"    "+L.tr("del-port-validation"),goingOn:function(){L.xapi.delPortForward(c.ID).then(function(a){c.selfMap.sections.splice(c.indexP,1);if(c.selfMap.sections.length==1){c.self.addNoPort(c.selfMap)}c.selfMap.redraw()});L.ui.popDialog(false);return},stopGoing:function(){L.ui.popDialog(false);return}});d.show()},saveFun:function(h){var j=this;var k=h;var l=this.portMap;var n={};n.portName=k.port_name;n.portProtocol=k.port_protocol;n.portIp=k.port_ip;n.portOutside=k.port_outside.split("-")[1]?k.port_outside:k.port_outside.split("-")[0];n.portInside=k.port_inside.split("-")[1]?k.port_inside:k.port_inside.split("-")[0];n.portState=k.port_state;n.selfMap=l;if(!k.ID){n.ID=""}else{n.ID=k.ID}var m=this.portOriginData.portIpBefore+n.portIp;var i=new L.cbi.Modal("upgrade_prompt",{bodyText:L.tr("setting-now-validation"),});i.show();L.xapi.getPortForward().then(function(f){var b=false;var a=k.port_outside.split("-");var c;for(var d=0;d<f.info.length;d++){c=f.info[d].src_dport.split("-");if(k.indexP!=(d+1)&&(a[0]==c[0]||(c.length!=1&&(a[0]==c[1])||(a[0]>=c[0]&&a[0]<=c[1])||(a.length!=1&&a[1]<=c[1]&&a[1]>=c[0]))||(a.length!=1&&(a[1]==c[0])||(a[0]<=c[0]&&a[1]>=c[0])))){b=true;break}}if(b){var e=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("port-input-twice-validation"),goingOn:function(){L.ui.popDialog(false);return},});e.show();return}else{L.xapi.setPortForward(n.ID,parseInt(n.portState),n.portName,n.portProtocol,n.portOutside,m,n.portInside).then(function(g){switch(g.status){case 0:n.delBtnStyle=j.portOriginData.delBtnStyle;n.delBtnText=j.portOriginData.delBtnText;n.editBtnStyle=j.portOriginData.editBtnStyle;n.editBtnText=j.portOriginData.editBtnText;n.portIpBefore=j.portOriginData.portIpBefore;n.portStateText0=j.portOriginData.portStateText0;n.portStateText1=j.portOriginData.portStateText1;n.saveBtnStyle=j.portOriginData.saveBtnStyle;n.saveBtnText=j.portOriginData.saveBtnText;n.cancelBtnStyle=j.portOriginData.cancelBtnStyle;n.cancelBtnText=j.portOriginData.cancelBtnText;n.self=j.portOriginData.self;n.ID=g.id;l=n.self.addHadPort(n);var q=l.sections.length;l.sections.splice(k.indexP,1,l.sections[q-1]);l.sections.splice(q-1,1);l.redraw();$(".unable-opcity").removeClass("unable-opcity");$(".port-add-icon").css("background",'url("/newifi/icons/portdmz-add.png") no-repeat -24px 0');var r=new L.cbi.Modal("upgrade_prompt",{bodyText:L.tr("setting-success-validation"),});r.show();setTimeout(function(){L.ui.popDialog(false)},3000);break;case 2:var r=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("name-input-error-validation"),goingOn:function(){L.ui.popDialog(false);return},});r.show();return;case 3:var r=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("ip-input-error-validation"),goingOn:function(){L.ui.popDialog(false);return},});r.show();return;case 4:var r=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("port-input-error-validation"),goingOn:function(){L.ui.popDialog(false);return},});r.show();return;default:var r=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("set-failed-validation"),goingOn:function(){L.ui.popDialog(false);return},});r.show();return}})}})},cancelFun:function(c){if(c.portName==""){c.selfMap.sections.splice(c.indexP,1)}else{if(c.portOutside1==""){c.portOutside=c.portOutside0}else{c.portOutside=c.portOutside0+"-"+c.portOutside1}if(c.portInside1==""){c.portInside=c.portInside0}else{c.portInside=c.portInside0+"-"+c.portInside1}c.selfMap=c.self.addHadPort(c);var d=c.selfMap.sections.length;c.selfMap.sections.splice(c.indexP,1,c.selfMap.sections[d-1]);c.selfMap.sections.splice(d-1,1)}if(c.selfMap.sections.length==1){c.self.addNoPort(c.selfMap)}c.selfMap.redraw();$(".unable-opcity").removeClass("unable-opcity");$(".port-add-icon").css("background",'url("/newifi/icons/portdmz-add.png") no-repeat -24px 0')},addNoPort:function(d){var f=d;var e=f.section(L.cbi.PortSection,"portSectionN",{portNoText:L.tr("not-have-data-validation"),});return f},addHadPort:function(c){var d=c.selfMap.section(L.cbi.PortSection,"portSection1",{delBtnStyle:c.delBtnStyle,delBtnText:c.delBtnText,editBtnStyle:c.editBtnStyle,editBtnText:c.editBtnText,portName:c.portName,portProtocol:c.portProtocol,portIp:c.portIp,portIpBefore:c.portIpBefore,portOutside:c.portOutside,portInside:c.portInside,portState:c.portState,portStateText:c.portState=="0"?c.portStateText1:c.portStateText0,portOriginData:c,editFun:this.editFun,delFun:this.delFun,});return c.selfMap},addCreatPort:function(c){var d=c.selfMap.section(L.cbi.PortSection,"portSection2",{saveBtnStyle:c.saveBtnStyle,saveBtnText:c.saveBtnText,cancelBtnStyle:c.cancelBtnStyle,cancelBtnText:c.cancelBtnText,saveData:["portSection2","port_name","port_protocol","port_ip","port_outside","port_inside","port_state"],portOriginData:c,portMap:c.selfMap,saveFun:this.saveFun,cancelFun:this.cancelFun,});d.option(L.cbi.InputValue,"port_name",{inputSyle:"port",inputText:c.portName,valueWidth:"port-name-width",datatype:"portName",});d.option(L.cbi.ListValue,"port_protocol",{valueWidth:"port-protocol-width",defaultT:c.portProtocol,}).value("TCP","TCP").value("UDP","UDP").value("TCP+UDP","TCP+UDP");d.option(L.cbi.IpDealValue,"port_ip",{portIp:c.portIp,ipValue:c.portIpBefore,valueWidth:"port-ip-width",datatype:"portIp",});d.option(L.cbi.PortValue,"port_outside",{port0:c.portOutside0,port1:c.portOutside1,valueWidth:"port-outside-width",datatype:function(){var a=$(".port-outside-width").find(".ip-enter-one").val();var b=$(".port-outside-width").find(".ip-enter-two").val();if(a.length==0){return L.tr("port-outside-empty-validation")}if(a>65535||a<0||(a.match(/^-?[0-9]+$/)==null)||(b.length>0&&(b>65535||b<0||(b.match(/^-?[0-9]+$/)==null)))){return L.tr("port-wrong-validation")}if(b.length>0&&(parseInt(a)>parseInt(b))){return L.tr("port-unable-validation")}},});d.option(L.cbi.PortValue,"port_inside",{port0:c.portInside0,port1:c.portInside1,valueWidth:"port-inside-width",datatype:function(){var a=$(".port-inside-width").find(".ip-enter-one").val();var b=$(".port-inside-width").find(".ip-enter-two").val();if(a.length==0){return L.tr("port-inside-empty-validation")}if(a>65535||a<0||(a.match(/^-?[0-9]+$/)==null)||(b.length>0&&(b>65535||b<0||(b.match(/^-?[0-9]+$/)==null)))){return L.tr("port-wrong-validation")}if(b.length>0&&(parseInt(a)>parseInt(b))){return L.tr("port-unable-validation")}},});d.option(L.cbi.RadioValue,"port_state",{portState:c.portState,portStateText0:c.portStateText0,portStateText1:c.portStateText1,valueWidth:"port-state-width",});return c.selfMap},createNewEntry:function(d,c){L.xapi.getLanIp().then(function(g){var h=g.ipaddr.split(".");h.splice(3,1);var b=h.join(".")+".";var a={};a.portName="";a.portProtocol="TCP";a.portIp="";a.portOutside0="";a.portOutside1="";a.portInside0="";a.portInside1="";a.portState="1";a.saveBtnStyle="portSave";a.saveBtnText=L.tr("Save");a.cancelBtnStyle="portCancel";a.cancelBtnText=L.tr("cancel");a.portStateText0=L.tr("enable");a.portStateText1=L.tr("disable");a.delBtnStyle="portDel";a.delBtnText=L.tr("delete");a.editBtnStyle="portEdit";a.editBtnText=L.tr("edit");a.selfMap=d;a.self=c;a.portIpBefore=b;$("#port_addNewEntery").on("click",a,c.port_addNewEntery);d.insertInto("#portdmz_port")})},initPage:function(e){var f=new L.cbi.Map("portsection",{pageaction:false});var d=f.section(L.cbi.PortSection,"portSection0",{});L.xapi.getPortForward().then(function(h){if(!h||!h.info||h.info.length==0){f=e.addNoPort(f);return}for(var c=0;c<h.info.length;c++){var a={};a.delBtnStyle="portDel";a.editBtnStyle="portEdit";a.delBtnText=L.tr("delete");a.editBtnText=L.tr("edit");a.portName=L.tr(h.info[c].name);a.portProtocol=h.info[c].proto;var b=h.info[c].dest_ip.split(".");a.portIp=b[3];a.portIpBefore=b[0]+"."+b[1]+"."+b[2]+".";a.portOutside=h.info[c].src_dport;a.portInside=h.info[c].dest_port;a.portState=h.info[c].enabled;a.portStateText0=L.tr("enable");a.portStateText1=L.tr("disable");a.saveBtnStyle="portSave";a.saveBtnText=L.tr("Save");a.cancelBtnStyle="portCancel";a.cancelBtnText=L.tr("cancel");a.self=e;a.ID=h.info[c].ID;a.selfMap=f;f=e.addHadPort(a)}});e.createNewEntry(f,e)},dmzShow:function(n,k,q){var m=k.ipaddr.split(".");var r=m[0]+"."+m[1]+"."+m[2]+".254";if(q==0){var o=n.status==1?r:n.ipaddr;var p=n.status==1?"0":n.enabled.toString()}else{var o=q.status==1?r:q.ipaddr;var p=q.status==1?"0":q.enabled.toString()}var j=o.substring(0,o.lastIndexOf(".")+1);var l=o.substring(o.lastIndexOf(".")+1,o.length+1);$(".dmz-on").find(".has-error").removeClass("has-error");$(".dmz-on").find(".dmz-error").attr("style","display: none;").text("");$("#dmz_ip_pre").text(j);$(".dmz-input").val(l);if(p=="1"){$(".dmz-status").text(L.tr("enable"))}else{$(".dmz-status").text(L.tr("disable"))}},ipValidate:function(){$(".dmz-input").on({"keyup blur":function(){var b=$(".dmz-input").val();if(!b){$(this).parents(".form-group").addClass("has-error");$("#dmz_btn").attr("disabled",true).addClass("btn-unable").removeClass("btn-ready");$(".dmz-error").attr("style","display: inline;").text(L.tr("plz-input-dzm-host-ip-validation"))}else{if(b.match(/^-?[0-9]+$/)!=null&&(parseInt(b)>1&&parseInt(b)<255)){$(this).parents(".form-group").removeClass("has-error");$(".dmz-error").hide().text("");$("#dmz_btn").attr("disabled",false).removeClass("btn-unable").addClass("btn-ready")}else{$(this).parents(".form-group").addClass("has-error");$(".dmz-error").attr("style","display: inline;").text(L.tr("plz-input-2-254-validation"));$("#dmz_btn").attr("disabled",true).addClass("btn-unable").removeClass("btn-ready")}}}})},dmzHelp:function(){$(".dmz-icon,.dmz-help-panel").hover(function(){$(".dmz-icon,.dmz-help-panel").stop();$(".dmz-help-panel").show();$(".dmz-help-icon").attr("style","background-position: -22px 0")},function(){$(".dmz-icon,.dmz-help-panel").stop();$(".dmz-help-panel").hide();$(".dmz-help-icon").attr("style","background-position: 0 0")})},renderDmz:function(e,g){var f=this;var h=e.status==0?e.on_off.toString():"0";if(h=="1"){$("#dmz_switch").addClass("switch-on");$(".dmz-on").show();$(".dmz-off").hide()}else{$("#dmz_switch").addClass("switch-off");$(".dmz-on").hide();$(".dmz-off").show()}f.dmzShow(e,g,0);f.dmzHelp()},switchDMZ:function(e,d){var f=this;$("#dmz_switch").click(function(){if($(this).hasClass("switch-on")){L.xapi.getDMZ().then(function(b){L.xapi.setDMZ(0,0,b.ipaddr).then(function(c){})});if($(this).hasClass("disabled")){$(this).click(function(){return false})}else{$(this).removeClass("switch-on").addClass("switch-off disabled");setTimeout(function a(){$(".dmz-switch").removeClass("disabled")},1000);$(".dmz-on").hide();$(".dmz-off").show()}}else{L.xapi.getDMZ().then(function(b){L.xapi.setDMZ(1,0,b.ipaddr).then(function(c){})});if($(this).hasClass("disabled")){$(this).click(function(){return false})}else{$(this).addClass("switch-on disabled").removeClass("switch-off");setTimeout(function a(){$(".dmz-switch").removeClass("disabled")},1000);$(".dmz-on").show();$(".dmz-off").hide();L.xapi.getDMZ().then(function(b){f.dmzShow(e,d,b)})}}})},saveDMZ:function(b){$("#dmz_btn").click(function(){var a=$(".dmz-input").val();var g=b.ipaddr.split(".");var f=g[0]+"."+g[1]+"."+g[2]+"."+a;var h=new L.cbi.Modal("upgrade_prompt",{bodyText:L.tr("setting-now-validation"),});h.show();if(f==b.ipaddr){var h=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("dmz-ip-lanip-same-validation"),goingOn:function(){L.ui.popDialog(false);return},});h.show();return}L.xapi.setDMZ(1,1,f).then(function(d){switch(d.status){case 0:$(".dmz-status").text(L.tr("enable"));var c=new L.cbi.Modal("upgrade_prompt",{bodyText:L.tr("setting-success-validation"),});c.show();setTimeout(function(){L.ui.popDialog(false)},3000);break;case 2:var c=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("ip-input-error-validation"),goingOn:function(){L.ui.popDialog(false);return},});c.show();break;default:var c=new L.cbi.Modal("system",{pageaction:false,title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("set-failed-validation"),goingOn:function(){L.ui.popDialog(false);return},});c.show()}})})},execute:function(){var b=this;b.initPage(b);L.xapi.getDMZ().then(function(a){L.xapi.getLanIp().then(function(d){b.renderDmz(a,d);b.switchDMZ(a,d);b.saveDMZ(d)})});b.ipValidate()}});