L.ui.view.extend({renderInstallState:function(h,f){var e;function g(a){L.xapi.appInstallStatus(a).then(function(b){switch(b.install_status.status){case 0:var c=new L.cbi.Modal("system",{bodyText:L.tr("app-upgrade-success-validation"),});c.show();setTimeout(function(){L.ui.popDialog(false);f(h)},5000);clearInterval(e);break;case 1:case 4:var c=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("应用校验失败"),goingOn:function(){L.ui.popDialog(false);return},});c.show();clearInterval(e);break;case 2:var c=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"double",btnF:"cancel",btnL:L.tr("retry"),bodyText:[L.tr("usb-disk-not-have-validation")],goingOn:function(){self.appUpgrade(h,f)},stopGoing:function(){L.ui.popDialog(false);return},});c.show();clearInterval(e);break;case 3:var c=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("usb-disk-full-validation"),goingOn:function(){L.ui.popDialog(false);return},});c.show();clearInterval(e);break;case 7:case 8:break;case 9:var c=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("磁盘只读"),goingOn:function(){L.ui.popDialog(false);return},});c.show();clearInterval(e);break;case 5:case 6:default:var c=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("app-download-fail-validation"),goingOn:function(){L.ui.popDialog(false);return},});c.show();clearInterval(e)}})}g(h.plugin_ID);e=setInterval(function(){g(h.plugin_ID)},5000);timeInterval.push(e)},appUpgrade:function(d,f){var e=this;L.xapi.appUpdate(d.plugin_ID,d.url).then(function(b){switch(b.status){case 0:var a=new L.cbi.Modal("system",{bodyText:L.tr("app-upgrade-install-now-validation"),iconType:"icon-refresh"});a.show();e.renderInstallState(d,f);break;case 100:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("服务器繁忙，请稍后再试……"),goingOn:function(){L.ui.popDialog(false);return},});a.show();break;case 2:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"double",btnF:"cancel",btnL:L.tr("retry"),bodyText:[L.tr("usb-disk-not-have-validation")],goingOn:function(){e.appUpgrade(d,f)},stopGoing:function(){L.ui.popDialog(false);return},});a.show();break;case 3:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("usb-disk-full-validation"),goingOn:function(){L.ui.popDialog(false);return},});a.show();break;case 9:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("磁盘只读"),goingOn:function(){L.ui.popDialog(false);return},});a.show();break;case 1:default:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("app-upgrade-failed-validation"),goingOn:function(){L.ui.popDialog(false);return},});a.show()}})},appUninstall:function(d,f){var e=new L.cbi.Modal("system",{bodyText:L.tr("app-uninstall-now-validation"),iconType:"icon-refresh"});e.show();setTimeout(function(){L.xapi.appUninstall(d.data.plugin_ID).then(function(b){switch(b.status){case 0:var a=new L.cbi.Modal("system",{bodyText:L.tr("app-uninstall-success-validation"),});a.show();f();setTimeout(function(){L.ui.popDialog(false);top.location.reload()},3000);break;default:var a=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"ready",bodyText:L.tr("app-uninstall-fail-validation"),goingOn:function(){L.ui.popDialog(false);return},});a.show()}})},1000)},appPage:function(p){$("#plugin_modal").show();$("body").attr({style:"overflow: hidden"});var r=parseInt(p.plugin_Space);var l=p.plugin_InstallDate.split("_");var q=l[0]+" "+l[1];var o=0;for(;Math.floor(r/1024);o++){r=r/1024}r=r.toFixed(2);switch(o){case 0:r=r.toString()+"B";break;case 1:r=r.toString()+"KB";break;case 2:r=r.toString()+"MB";break}var k=p.plugin_Name;var n=p.plugin_Source;var m=p.plugin_Info.split("\n");var i="";L.xapi.getLanIp().then(function(c){i=c.ipaddr;var a="http:/"+i+"/apptest/index.html";var b=new L.cbi.Detail("test",{pluginSection:L.tr("viewmenu-title-install"),isExist:n=="0"?false:true,isInstall:true,isLatest:p.updateFlag,isSet:p.plugin_html==""?false:true,imgUrl:p.plugin_Largeicon+"large.jpg",setUrl:p.plugin_html,gloriousName:p,pluginData:{title:k,basicInfo:[{name:L.tr("app-size"),value:r},{name:L.tr("app-model"),value:p.plugin_VersionName},{name:L.tr("app-install-time"),value:q}],detailsInfo:[{name:L.tr("app-developer"),value:p.plugin_Author}]},appData:m,handleInstall:function(d){},handleUpdate:function(e){var d=new L.cbi.Modal("system",{bodyText:L.tr("app-upgrade-now-validation"),iconType:"icon-refresh"});d.show();appSelf.appUpgrade(e.data,function(f){L.xapi.getAppInfo(e.data.plugin_ID).then(function(g){g.appinfo.updateFlag=true;appSelf.appPage(g.appinfo)})})},handleUninstall:function(e){var d=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"double",btnF:"cancel",btnL:L.tr("uninstall"),bodyText:[L.tr("uninstall-warming-validation")],goingOn:function(){appSelf.appUninstall(e,function(){$("#plugin_detail").hide();$("#plugin_modal").hide();$("body").attr({style:"overflow: auto"})})},stopGoing:function(){L.ui.popDialog(false);return},});d.show()},handleClose:function(){$("#plugin_detail").hide().empty();$("#plugin_modal").hide();$("body").attr({style:"overflow: auto"})}});return b.insertInto("#plugin_detail")})},showInTheMap:function(m){var k=this;var j="";var n="";for(var h=0;h<m.length;h++){if("160106666"==m[h].plugin_ID){continue}var i=new L.cbi.AllappPlugins("upgrade_prompt",{appType:"installed",isOfficial:m[h].plugin_Officeapp=="1"?1:0,isInstalled:false,isLocal:true,isOwn:m[h].plugin_Source=="0"?false:true,imgPath:m[h].plugin_Largeicon+"small.png",isLatest:m[h].updateFlag,pluginTitle:m[h].plugin_Name,pluginDescr:m[h].plugin_Info!=""?m[h].plugin_Info:L.tr("author-is-lazy-vedition"),appData:m[h],uninstallApp:function(a){var b=new L.cbi.Modal("system",{title:L.tr("prompt-message"),footer:"double",btnF:"cancel",btnL:L.tr("uninstall"),bodyText:[L.tr("uninstall-warming-validation")],goingOn:function(){appSelf.appUninstall(a,function(){})},stopGoing:function(){L.ui.popDialog(false);return},});b.show()},upgradeApp:function(a){var b=new L.cbi.Modal("system",{bodyText:L.tr("app-upgrade-now-validation"),iconType:"icon-refresh"});b.show();a.data.updateFlag=true;appSelf.appUpgrade(a.data,function(){setTimeout(function(){L.ui.popDialog(false);top.location.reload()},3000)})},detailPage:function(a){k.appPage(a.data)},});i.appendTo($("#map"))}var l=new L.cbi.AllappPlugins("upgrade_prompt",{isGoAllapp:true,allApp:function(a){var b=window.location.href;var c=b.split("/");b=c[0]+"//"+c[2]+"/"+c[3]+"/allapp";window.location.href=b}});l.appendTo($("#map"))},getAppSuccess:function(h,n){var k=this;var m=h;if(!h||h.length==0){return}var l=0;for(var i=0;i<n.length;i++){for(var j=0;j<m.length;j++){if(m[j].appid=="151130682"){m[j].appid="4"}if(n[i].plugin_ID==m[j].appid){n[i].url=m[j].url;if(n[i].plugin_VersionName<m[j].version){n[i].updateFlag=false;l=1}}}}if(l==0){return}$("#map").empty();k.showInTheMap(n)},getAppInfo:function(s,p,m,t){var v=this;appSelf=this;var u="http://online-api.xcloud.cc/router/getAppList?";var o="1.0.0.2";var q="1.1.1.1";var n="alpha";var l="";var r="xCloudOS";L.xapi.getAppInfo("all_id").then(function(a){L.xapi.getAdvanceInfo().then(function(c){if(c.platform=="y1"){devicePlatform="y1"}else{if(c.platform=="y1s"){devicePlatform="y1s"}else{if(c.platform=="newifi-d1"){devicePlatform="newifi-d1"}else{if(c.platform=="newifi-d2"){devicePlatform="newifi-d2"}}}}localMac=c.macaddr;firmware=c.version;u="http://online-api.xcloud.cc/router/plugins/update";var b={api_version:"1.0.1.1",platform:devicePlatform,mac:localMac,firmware:firmware,force:"false",p:"1",pagesize:"",param:p,appids:m,versions:t};L.xapi.getUpgradeApp(u,b,function(d){if(d.errorcode!=0||d.data.length==0){return}appSelf.getAppSuccess(d.data,s)},function(){return});$.ajax({url:"/cgi-bin/get_app_info.cgi",method:"post",data:b,enctype:"multipart/form-data",success:function(d){}})})})},checkUsb:function(){var b=this;$("#more").empty();L.xapi.getUsbMountStatus().then(function(a){switch(a.status){case 0:case 3:break;case 2:var d=new L.cbi.StorageCheck("StorageCheck",{restart:function(){top.location.reload();L.xapi.reMountUsb(a.disk[0]).then(function(c){})},});d.appendTo($("#more"));break;case 1:default:var d=new L.cbi.StorageCheck("StorageCheck",{restart:function(){top.location.reload()},});d.appendTo($("#more"));break}})},execute:function(){var d=this;var c=[];L.xapi.getAppInfo("all").then(function(l){var b=l.appinfo;var j="";var a="";for(var k=0;k<b.length;k++){b[k].updateFlag=true;var i={};j+=b[k].plugin_ID+",";a+=b[k].plugin_VersionName+",";i.appid=b[k].plugin_ID;i.version=b[k].plugin_VersionName;c.push(i)}j=j.substring(0,j.length-1);a=a.substring(0,a.length-1);d.showInTheMap(b);d.getAppInfo(b,c,j,a)});d.checkUsb();return}});