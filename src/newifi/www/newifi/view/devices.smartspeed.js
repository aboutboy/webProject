L.ui.view.extend({deviceShow:function(t){var I,B;if(t.isLimited==true){I="show"}else{I="hide"}var D=["DELL","LENOVO","SMARTISAN","ZTE","THINKPAD","XIAOMI","COOLPAD","VIVO","MICROSOFT","HUAWEI","TCL","SONY","ASUS","OPPO","SAMSUNG","NOKIA","APPLE","LG","NUBIA","HTC","MEIZU","HP","LESHI","ACER"];var u=1;for(var x=0;x<D.length;x++){var J=t.producer_info;var A=J.indexOf(D[x]);if(A>=0){B="icon-"+D[x];break}else{if(u>=D.length){B="icon-public";break}else{u++;continue}}}var i=$("<tr />");var y=$("<td />").addClass("limit-symbol").append($("<img />").attr({src:"/newifi/icons/device_limit.png",alt:""}).addClass(I));if(t.isNative==true){var G=$("<td />").addClass("limit-devices").append($("<div />").addClass("limit-device-icon "+B)).append($("<div />").addClass("limit-device-info").append($("<p />").addClass("info-title").append($("<span />").addClass("native-title-text").text(t.deviceName=="unkown"?L.tr("unknown-device-name"):t.deviceName)).append($("<span />").addClass("native-title-label").text(L.tr("local-device"))).append($("<div />").addClass("clearfix"))).append($("<p />").addClass("info-type").text(t.linkType)))}else{var G=$("<td />").addClass("limit-devices").append($("<div />").addClass("limit-device-icon "+B)).append($("<div />").addClass("limit-device-info").append($("<p />").addClass("info-title").text(t.deviceName=="unkown"?L.tr("unknown-device-name"):t.deviceName)).append($("<p />").addClass("info-type").text(t.linkType)))}var w=$("<td>").addClass("limit-info").append($("<p />").append($("<span />").addClass("limit-info-title").text(L.tr("mac-address"))).append($("<span />").addClass("limit-info-value").text(t.macAddr))).append($("<p />").append($("<span />").addClass("limit-info-title").text(L.tr("ip-address"))).append($("<span />").addClass("limit-info-value").text(t.IPAddr))).append($("<p />").append($("<span />").addClass("limit-info-title").text(L.tr("conn-time"))).append($("<span />").addClass("limit-info-value").text(t.linkTime)));var z=$("<td>").addClass("limit-network").append($("<p />").append($("<span />").addClass("limit-network-title").text(L.tr("download"))).append($("<span />").addClass("limit-network-value").text(t.netDown))).append($("<p />").append($("<span />").addClass("limit-network-title").text(L.tr("upload"))).append($("<span />").addClass("limit-network-value").text(t.netUp)));var F={"keyup blur":function(){var b=$(this).parent().siblings();var a=$(this).val();if(a.match(/^-?[0-9]+$/)!=null&&(parseFloat(a)>0&&parseFloat(a)<101)){$(this).parent().removeClass("group-error");if(b.hasClass("group-error")){return}$(this).parents(".limit-broadband").find(".limit-error").hide()}else{$(this).parent().addClass("group-error").parents(".limit-broadband").find(".limit-error").show()}if($(".form-limit .group-limit").hasClass("group-error")){$("#btn_device_save").addClass("btn-unable").removeClass("btn-ready").attr("disabled","disabled")}else{$("#btn_device_save").removeClass("btn-unable").addClass("btn-ready").attr("disabled",false)}}};var H=t.IPAddr.replace(/\./g,"_");var E=L.ui.inputPersent("上传",H+"_up",t.limitUp,F);var v=L.ui.inputPersent("下载",H+"_down",t.limitDown,F);var C=$("<td />").addClass("limit-broadband").attr({id:H}).append($("<form />").addClass("form-inline form-limit").append(E).append(v)).append($("<div />").addClass("label label-danger limit-error").attr({style:"display: none"}).text(L.tr("qos-input-wrong-validation")));i.append(y).append(G).append(w).append(z).append(C).appendTo("tbody")},deviceNull:function(){var b=$("<tr />").addClass("limit-device-no").append($("<td />").attr({colspan:"5"}).text(L.tr("not-have-validation"))).appendTo("tbody");$(".limit-footer").hide()},speedFormat:function(e){var f;var d;if(parseInt(e/1024)){f=parseInt(e/1024);d="KB/s";if(parseInt(e/(1024*1024))){f=parseInt(f/1024);d="MB/s"}}else{f=e;d="B/s"}return f.toString()+d},parseData:function(r){var v=this;var u={};var t=[["pc","windows","imac"],["android","iphone","winphone","samsung","Sony"],["pad","ipad"]];u.deviceType="3";var n=-1;for(var q=0;q<t.length;q++){for(var s=0;s<t[q].length;s++){n=r.device_name.toLowerCase().indexOf(t[q][s]);if(n!=-1){u.deviceType=q.toString()}}}u.netUp=v.speedFormat(r.upstream);u.netDown=v.speedFormat(r.downstream);u.macAddr=r.mac;u.IPAddr=r.ip;u.netType=r.connect_type=="lan"?L.tr("lan-net"):(r.connect_type=="ra0"?L.tr("2.4G-wifi"):L.tr("5G-wifi"));var p;if(r.device_nickname=="none"){p=r.device_name}else{p=$.base64.atob(r.device_nickname,true)}u.deviceName=p;var i=parseInt(r.time/86400);var j=parseInt((r.time%86400)/3600);var o=parseInt(((r.time%86400)%3600)/60);u.linkTime=i.toString()+L.tr("day")+j+L.tr("hour")+o+L.tr("minite");u.isNative=r.selfDevice;u.limitDown=r.dpercent;u.limitUp=r.upercent;u.producer_info=r.producer_info;u.isLimited=r.islimited=="1"?true:false;return u},renderDevice:function(g,f){var e=this;if(g=="0"){$(".limit-off").show();$(".limit-on").hide();$(".limit-switch").removeClass("switch-on").addClass("switch-off");clearInterval(smtSpedTime);return false}else{$(".limit-off").hide();$(".limit-on").show();$(".limit-switch").addClass("switch-on").removeClass("switch-off");if(f.length==0){e.deviceNull()}else{$(".limit-footer").show();for(var h=0;h<f.length;h++){e.deviceShow(e.parseData(f[h]))}}}},creatBtn:function(){var h=this;var e=L.ui.defaultBtn(L.tr("Save"),"ready","device_save").click(function(){var r=new L.cbi.Modal("devices",{bodyText:L.tr("set-now-validation"),});r.show();var i=[];var a=$(".limit-broadband");var t,s,c;var d=[];var q={};for(var b=0;b<a.length;b++){var p={};d=a[b].id.split("_");p.ip=d[0]+"."+d[1]+"."+d[2]+"."+d[3];d.length=0;p.uceil=$("#"+a[b].id+"_up").val();p.dceil=$("#"+a[b].id+"_down").val();if(p.uceil=="100"&&p.dceil=="100"){p.enable="0"}else{p.enable="1"}p.urate="5";p.drate="50";p.prio="4";i.push(p)}q.info=i;L.xapi.setSmartQos(JSON.stringify(q)).then(function(j){clearInterval(smtSpedTime);h.autoRefresh();setTimeout(function(){var k=new L.cbi.Modal("devices",{bodyText:L.tr("set-success-validation"),});k.show();$(".limit-refresh").show();h.refreshAction();setTimeout(function(){L.ui.popDialog(false)},2000)},1000)})});var f=L.ui.defaultBtn(L.tr("edit"),"ready","device_edit").click(function(){$("#btn_device_save").show();$(".input-limit").show();$(".limit-value").hide();$("#btn_device_cancel").show();$(".limit-refresh").hide();$(this).hide();clearInterval(smtSpedTime)});var g=L.ui.defaultBtn(L.tr("cancel"),"cancel","device_cancel").click(function(){$(".limit-refresh").show();h.refreshAction();clearInterval(smtSpedTime);h.autoRefresh()});$(".limit-footer").append(e).append(f).append(g)},switchLimit:function(){var b=this;$(".limit-switch").click(function(){$(".limit-refresh").show();$("#btn_device_edit").show();$("#btn_device_save").hide();$("#btn_device_cancel").hide();clearInterval(smtSpedTime);b.autoRefresh();if($(this).hasClass("switch-on")){if($(this).hasClass("disabled")){$(this).click(function(){return false})}else{$(this).removeClass("switch-on").addClass("switch-off disabled");setTimeout(function a(){$(".limit-switch").removeClass("disabled")},1000);clearInterval(smtSpedTime);L.xapi.switchOfQos(0).then(function(){$("tbody").empty();$(".limit-on").hide();$(".limit-off").show()})}}else{if($(this).hasClass("disabled")){$(this).click(function(){return false})}else{$(this).addClass("switch-on disabled").removeClass("switch-off");L.xapi.switchOfQos(1).then(function(d){$(".limit-on").show();$(".limit-off").hide();b.getDeviceInfo()});b.showMeasureContent(true)}}})},refreshAction:function(){var b=this;$("tbody").empty();$(".limit-footer").empty();b.getDeviceInfo();b.creatBtn()},deviceRefresh:function(){var b=this;$(".limit-refresh").click(function(){if($(this).hasClass("disabled")){$(this).click(function(){return false})}else{$(this).addClass("disabled");setTimeout(function a(){$(".limit-refresh").removeClass("disabled")},1000);b.refreshAction()}})},getSelfDeviceMac:function(b){$.ajax({url:"/cgi-bin/get_clientmac.cgi",method:"post",enctype:"multipart/form-data",success:function(a){a=a.replace("\n","");a=a.substring(0,a.length-1);b(a)}})},getDeviceInfo:function(){var b=this;b.getSelfDeviceMac(function(a){L.xapi.getDeviceInfo().then(function(d){L.xapi.getSmartQos().then(function(c){var o=c.qosenable;var r={};var p=d.info.length;var q={};var n=c.info;for(var i=0;i<n.length;i++){q[n[i].ip]=n[i]}for(var i=0;i<p;i++){d.info[i].selfDevice=false;d.info[i].upercent=q[d.info[i].ip].upercent;d.info[i].dpercent=q[d.info[i].ip].dpercent;d.info[i].islimited=q[d.info[i].ip].enable;if(d.info[i].mac==a){d.info[i].selfDevice=true;r=d.info[i];d.info[i]=d.info[0];d.info[0]=r}}for(var i=1;i<p-1;i++){for(var j=1;j<p-i;j++){if(d.info[j].time>d.info[j+1].time){r=d.info[j+1];d.info[j+1]=d.info[j];d.info[j]=r}}}b.renderDevice(o,d.info)})})})},autoRefresh:function(){var b=this;smtSpedTime=setInterval(function(){var a=window.location.href;URLARR=a.split("/");if(URLARR.pop()!="smartspeed"){clearInterval(smtSpedTime);return 0}b.refreshAction()},20000)},editTextExchange:function(c,d){$(c).parent().hide().siblings().show();$(d).hide().siblings().show()},showLimt:function(d,c){$(d).show();$(c).hide()},showMeasureData:function(c,d){$(".limit-measure-info-details").hide();$(".limit-measure-content").show();$("#text_measure_up").text(c);$("#input_measure_up").val(c);$("#text_measure_down").text(d);$("#input_measure_down").val(d)},showMeasureContent:function(n){var p=this;var l=0,m=0,i=0,o=0;var k;function j(){L.xapi.getSpeedTestState().then(function(a){l=parseFloat(a.upband/1024).toFixed(1);m=parseFloat(a.downband/1024).toFixed(1);i=a.upband_bak;o=a.downband_bak;switch(a.state){case 0:p.showLimt(".limit-measure-info-doing",".limit-measure-content, .limit-measure-info-failed, .limit-device-show");if(n==true){p.measureStart()}else{p.showMeasureData("----","----");clearInterval(k)}break;case 1:case 2:case 3:$(".limit-switch").addClass("disabled");p.showLimt(".limit-measure-info-doing",".limit-measure-content, .limit-measure-info-failed, .limit-device-show");break;case 4:$(".limit-switch").removeClass("disabled");p.showLimt(".limit-measure-info-failed, .limit-device-show",".limit-measure-content, .limit-measure-info-doing");clearInterval(k);break;case 5:$(".limit-switch").removeClass("disabled");$(".limit-device-show").show();if(!i||!o){p.showMeasureData(l,m)}else{p.showMeasureData(i,o)}clearInterval(k);break;case 7:$(".limit-switch").addClass("disabled");p.showLimt(".limit-measure-info-doing",".limit-measure-content, .limit-measure-info-failed, .limit-device-show");break;default:$(".limit-switch").removeClass("disabled");p.showLimt(".limit-measure-info-failed, .limit-device-show",".limit-measure-content, .limit-measure-info-doing");clearInterval(k)}})}j();k=setInterval(function(){j()},5000);timeInterval.push(k)},measureStart:function(){var b=this;L.xapi.speedTest(1).then(function(a){setTimeout(function(){b.showMeasureContent(true)},5000)})},measureStop:function(){var b=this;L.xapi.speedTest(0).then(function(a){b.showMeasureContent(false)})},resetState:function(){L.xapi.modifyConfig("speedtest","speedtest","state","5").then(function(b){})},measureBtn:function(){var b=this;$(".limit-measure-operate-check").click(function(){$(".limit-switch").addClass("disabled");b.showLimt(".limit-measure-info-doing",".limit-measure-content, .limit-measure-info-failed, .limit-device-show");b.measureStart()});$("#limit_measure_save").click(function(){var a=new L.cbi.Modal("limit_mearuse",{bodyText:L.tr("limit-measure-setting")});a.show();b.setMeasureBrand()});$("#measure_back").click(function(){b.resetState();b.showMeasureContent(false)});$("#limit_measure_edit").click(function(){$("#limit_measure_save").attr("disabled",false).addClass("btn-ready").removeClass("btn-unable");b.editTextExchange(this,".text-measure")});$("#limit_measure_cancel").click(function(){b.editTextExchange(this,".input-measure");b.showMeasureContent(false);$(".limit-measure-item").find(".group-error").removeClass("group-error");$(".measure-error").hide()});$("#measure_stop").click(function(){b.measureStop()})},setMeasureBrand:function(){var g=this;var i,j,h,f;h=$("#input_measure_up").val();f=$("#input_measure_down").val();i=parseInt(h*1024);j=parseInt(f*1024);L.xapi.setSmartQosBandwidth(i,h,j,f).then(function(a){if(a.error){var b=new L.cbi.Modal("limit_mearuse",{title:L.tr("prompt-message"),bodyText:L.tr("limit-measure-set-failed"),footer:"ready",goingOn:function(){L.ui.popDialog(false)},});b.show()}else{if(a.status==0){L.ui.popDialog(false);g.showMeasureContent(false);g.editTextExchange("#limit_measure_cancel",".input-measure")}else{var b=new L.cbi.Modal("limit_mearuse",{title:L.tr("prompt-message"),bodyText:L.tr("limit-measure-set-failed"),footer:"ready",goingOn:function(){L.ui.popDialog(false)},});b.show()}}})},inputMeasureValidate:function(){function b(e,f,a){$(e).on("keyup blur",function(){var c=$(e).val();/^-?[0-9]+$/;if(c.match(/^(\d+)$|(\d+\.{1}\d{1})$/)!=null&&c>=f&&c<=a){$(e).parent().removeClass("group-error");$(e).parents(".limit-measure-item").find(".measure-error").hide()}else{$(e).parent().addClass("group-error");$(e).parents(".limit-measure-item").find(".measure-error").css("display","inline-block");if(c<f||c>a){if($(e).parents(".limit-measure-item").find(".measure-error").hasClass("measure-error-up")){$(e).parents(".limit-measure-item").find(".measure-error").text(L.tr("limit-measure-exceed-up-validation"))}else{$(e).parents(".limit-measure-item").find(".measure-error").text(L.tr("limit-measure-exceed-down-validation"))}}else{$(e).parents(".limit-measure-item").find(".measure-error").text(L.tr("limit-measure-format-validation"))}}if($(".limit-measure-content .limit-measure-item-info").hasClass("group-error")){$("#limit_measure_save").attr("disabled",true).addClass("btn-unable").removeClass("btn-ready")}else{$("#limit_measure_save").attr("disabled",false).addClass("btn-ready").removeClass("btn-unable")}})}b("#input_measure_up",0.1,1024);b("#input_measure_down",0.5,2048)},execute:function(){var b=this;clearInterval(smtSpedTime);b.autoRefresh();b.switchLimit();b.getDeviceInfo();b.deviceRefresh();b.creatBtn();b.showMeasureContent(false);b.measureBtn();b.inputMeasureValidate()}});